#!/bin/bash

send_message () { curl -i - H "Accept: application/json" -X POST -H "Content-Type: application/json" -data :"{ \"content\": ${FETCH_RESULT} }" "${WEBHOOK_URL}" ; }
get_git_update () {
    cd "/home/directories/${USER}/${1}" 2>/dev/null && \
        UPDATED_BRANCHES=$(git fetch --all | grep -o "origin/\S\+")
        for BRANCH in ${UPDATED_BRANCHES}
        do
            git checkout "${BRANCH}"
            git log --pretty=oneline origin/master.. && \
            git pull --all --quiet
        done; cd ..
    }

echo "FETCHING DATA FOR ${*} -- $(date)"
cd /home/"${USER}"/directories || exit
for DIR_PATH in "${@}"
do
    echo "Fetching data for ${DIR_PATH}..."
    FETCH_RESULT=$(get_git_update "${DIR_PATH}") 2>&1
    if [ "${FETCH_RESULT}" != "" ]; then
        FETCH_RESULT="New commits for ${DIR_PATH}:\n${FETCH_RESULT}"
        send_message
    else echo "Nothing has been sent!"
    fi
done
